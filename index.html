<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#1a1a2e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>KWBB</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸšŒ</text></svg>">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    html, body {
      overscroll-behavior: none;
      background-color: #1a1a2e;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      min-height: 100vh;
      color: #fff;
      padding: 20px;
      padding-top: calc(20px + env(safe-area-inset-top));
      padding-bottom: calc(20px + env(safe-area-inset-bottom));
    }
    
    .container {
      max-width: 400px;
      margin: 0 auto;
    }
    
    .header {
      text-align: center;
      margin-bottom: 24px;
    }
    
    .header h1 {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 8px;
    }
    
    .current-time {
      font-size: 14px;
      color: rgba(255,255,255,0.6);
    }
    
    .direction-toggle {
      display: flex;
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 4px;
      margin-bottom: 24px;
    }
    
    .direction-btn {
      flex: 1;
      padding: 12px;
      border: none;
      background: transparent;
      color: rgba(255,255,255,0.6);
      font-size: 15px;
      font-weight: 500;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .direction-btn.active {
      background: #4f46e5;
      color: #fff;
    }
    
    .main-card {
      background: rgba(255,255,255,0.08);
      border-radius: 20px;
      padding: 24px;
      margin-bottom: 16px;
    }
    
    .next-bus-label {
      font-size: 14px;
      color: rgba(255,255,255,0.6);
      margin-bottom: 8px;
    }
    
    .next-bus-time {
      font-size: 48px;
      font-weight: 700;
      margin-bottom: 4px;
    }
    
    .next-bus-countdown {
      font-size: 18px;
      color: rgba(255,255,255,0.8);
      margin-bottom: 20px;
    }
    
    .action-box {
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
    }
    
    .action-emoji {
      font-size: 32px;
      margin-bottom: 8px;
    }
    
    .action-text {
      font-size: 18px;
      font-weight: 600;
    }
    
    .action-subtext {
      font-size: 14px;
      color: rgba(255,255,255,0.6);
      margin-top: 4px;
    }
    
    .later-buses {
      background: rgba(255,255,255,0.05);
      border-radius: 16px;
      padding: 16px;
    }
    
    .later-label {
      font-size: 13px;
      color: rgba(255,255,255,0.5);
      margin-bottom: 12px;
    }
    
    .later-list {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    
    .later-item {
      background: rgba(255,255,255,0.1);
      padding: 8px 14px;
      border-radius: 8px;
      font-size: 15px;
    }
    
    .no-service {
      text-align: center;
      padding: 40px 20px;
    }
    
    .no-service-emoji {
      font-size: 48px;
      margin-bottom: 16px;
    }
    
    .no-service-text {
      font-size: 18px;
      color: rgba(255,255,255,0.8);
    }
    
    .schedule-toggle {
      background: rgba(255,255,255,0.05);
      border: none;
      border-radius: 12px;
      padding: 14px 16px;
      color: rgba(255,255,255,0.6);
      font-size: 14px;
      width: 100%;
      text-align: center;
      cursor: pointer;
      margin-top: 16px;
      transition: all 0.2s;
    }
    
    .schedule-toggle:hover {
      background: rgba(255,255,255,0.1);
    }
    
    .schedule-panel {
      background: rgba(255,255,255,0.05);
      border-radius: 16px;
      padding: 16px;
      margin-top: 12px;
      display: none;
    }
    
    .schedule-panel.open {
      display: block;
    }
    
    .schedule-section {
      margin-bottom: 20px;
    }
    
    .schedule-section:last-child {
      margin-bottom: 0;
    }
    
    .schedule-section-title {
      font-size: 14px;
      font-weight: 600;
      color: rgba(255,255,255,0.8);
      margin-bottom: 10px;
      padding-bottom: 6px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .schedule-times {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    
    .schedule-time {
      background: rgba(255,255,255,0.08);
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 13px;
      color: rgba(255,255,255,0.7);
    }
    
    .schedule-note {
      font-size: 12px;
      color: rgba(255,255,255,0.5);
      margin-top: 12px;
      padding: 10px;
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <div class="container" id="app"></div>

  <script>
    // æ™‚åˆ»è¡¨è³‡æ–™ï¼ˆå¾ CSV è¼‰å…¥ï¼‰
    let schedule = {
      weekday: { toMRT: [], toCondo: [] },
      weekend: { toMRT: [], toCondo: [] }
    };
    
    // è¼‰å…¥ CSV
    async function loadSchedule() {
      try {
        const response = await fetch('schedule.csv');
        const text = await response.text();
        const lines = text.trim().split('\n').slice(1); // è·³é header
        
        lines.forEach(line => {
          const [dayType, direction, time] = line.split(',');
          if (schedule[dayType] && schedule[dayType][direction]) {
            schedule[dayType][direction].push(time);
          }
        });
        
        render();
      } catch (error) {
        console.error('ç„¡æ³•è¼‰å…¥æ™‚åˆ»è¡¨:', error);
        // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
        document.getElementById('app').innerHTML = `
          <div class="header">
            <h1>ğŸšŒ KWBB</h1>
          </div>
          <div class="main-card">
            <div class="no-service">
              <div class="no-service-emoji">âš ï¸</div>
              <div class="no-service-text">ç„¡æ³•è¼‰å…¥æ™‚åˆ»è¡¨</div>
            </div>
          </div>
        `;
      }
    }

    let direction = 'toCondo';
    let scheduleOpen = false;

    function getScheduleType(date) {
      const day = date.getDay();
      if (day === 0 || day === 6) return 'weekend'; // é€±å…­æ—¥
      return 'weekday';
    }

    function timeToMinutes(timeStr) {
      const hours = parseInt(timeStr.substring(0, 2));
      const mins = parseInt(timeStr.substring(2, 4));
      return hours * 60 + mins;
    }

    function formatTime(timeStr) {
      return timeStr.substring(0, 2) + ':' + timeStr.substring(2, 4);
    }

    function getCurrentMinutes(date) {
      return date.getHours() * 60 + date.getMinutes();
    }

    function getDayName(date) {
      const days = ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­'];
      return days[date.getDay()];
    }

    function getNextBuses(date, dir) {
      const scheduleType = getScheduleType(date);
      const times = schedule[scheduleType][dir];
      const currentMins = getCurrentMinutes(date);
      
      const upcoming = times.filter(t => timeToMinutes(t) > currentMins);
      return upcoming;
    }

    function getAction(minutesUntil, dir, date) {
      // å¾€ MRTï¼šå¾ Condo ç™¼è»Šï¼Œæº–æ™‚ä¸ç­‰äººï¼Œèµ°è·¯ 5 åˆ†é˜
      // å¾€ Condoï¼šå¾ MRT æ­ï¼Œè»Šå¯èƒ½é²åˆ° 0-3 åˆ†é˜ï¼Œå¯ä»¥è³­

      if (dir === 'toMRT') {
        // å¾€ MRT - æº–æ™‚ç™¼è»Šï¼Œä¸èƒ½è³­
        const day = date.getDay();
        const isWeekend = day === 0 || day === 6;
        const minus_minutes = isWeekend ? 10 : 15;
        if (minutesUntil > minus_minutes) {
          const canSit = minutesUntil - minus_minutes;
          return {
            emoji: 'â˜•',
            text: `é‚„å¯ä»¥å ${canSit} åˆ†é˜`,
            subtext: 'æ™‚é–“åˆ°äº†å†å»æ­è»Š'
          };
        } else if (minutesUntil >= 5) {
          return {
            emoji: 'ğŸš¶',
            text: 'å¯ä»¥å‡ºé–€äº†',
            subtext: 'èµ°éå»å‰›å¥½ä¸Šè»Š'
          };
        } else {
          return {
            emoji: 'â­',
            text: 'é€™ç­ä¾†ä¸åŠäº†',
            subtext: 'ç­‰ä¸‹ä¸€ç­å§'
          };
        }
      } else {
        // å¾€ Condo - è»Šå¯èƒ½é²åˆ°ï¼Œå¯ä»¥è³­
        if (minutesUntil > 10) {
          const canSit = minutesUntil - 10;
          return {
            emoji: 'â˜•',
            text: `é‚„å¯ä»¥å ${canSit} åˆ†é˜`,
            subtext: 'æ™‚é–“åˆ°äº†å†èµ°å»æ’éšŠ'
          };
        } else if (minutesUntil >= 5) {
          return {
            emoji: 'ğŸš¶',
            text: 'ç›´æ¥å»æ’éšŠ',
            subtext: 'ç¾åœ¨å‡ºç™¼å‰›å¥½'
          };
        } else if (minutesUntil >= 1) {
          return {
            emoji: 'ğŸƒ',
            text: 'è·‘ä¸€ä¸‹å¯èƒ½è¶•ä¸Šï¼',
            subtext: 'è»Šå¯èƒ½æœƒé²åˆ° 1-2 åˆ†é˜'
          };
        } else {
          return {
            emoji: 'â­',
            text: 'é€™ç­ä¾†ä¸åŠäº†',
            subtext: 'çœ‹ä¸‹ä¸€ç­å§'
          };
        }
      }
    }

    function render() {
      const now = new Date();
      const app = document.getElementById('app');
      
      // é‚„æ²’è¼‰å…¥å®Œæˆ
      if (schedule.weekday.toMRT.length === 0) return;
      
      const nextBuses = getNextBuses(now, direction);
      
      const currentTimeStr = 
        now.getHours().toString().padStart(2, '0') + ':' + 
        now.getMinutes().toString().padStart(2, '0');
      
      let content = `
        <div class="header">
          <h1>ğŸšŒ KWBB</h1>
          <div class="current-time">ç¾åœ¨ ${currentTimeStr}ï¼ˆ${getDayName(now)}ï¼‰</div>
        </div>
        
        <div class="direction-toggle">
          <button class="direction-btn ${direction === 'toCondo' ? 'active' : ''}" onclick="setDirection('toCondo')">
            å¾€ Condo
          </button>
          <button class="direction-btn ${direction === 'toMRT' ? 'active' : ''}" onclick="setDirection('toMRT')">
            å¾€ MRT
          </button>
        </div>
      `;
      
      if (nextBuses.length === 0) {
        content += `
          <div class="main-card">
            <div class="no-service">
              <div class="no-service-emoji">ğŸ˜´</div>
              <div class="no-service-text">ä»Šå¤©æ²’æœ‰æ›´å¤šç­æ¬¡äº†</div>
            </div>
          </div>
        `;
      } else {
        const nextBus = nextBuses[0];
        const nextBusMins = timeToMinutes(nextBus);
        const currentMins = getCurrentMinutes(now);
        const minutesUntil = nextBusMins - currentMins;
        const action = getAction(minutesUntil, direction, now);
        
        content += `
          <div class="main-card">
            <div class="next-bus-label">ä¸‹ä¸€ç­</div>
            <div class="next-bus-time">${formatTime(nextBus)}</div>
            <div class="next-bus-countdown">${minutesUntil} åˆ†é˜å¾Œ</div>
            
            <div class="action-box">
              <div class="action-emoji">${action.emoji}</div>
              <div class="action-text">${action.text}</div>
              <div class="action-subtext">${action.subtext}</div>
            </div>
          </div>
        `;
        
        if (nextBuses.length > 1) {
          const laterBuses = nextBuses.slice(1, 5);
          content += `
            <div class="later-buses">
              <div class="later-label">ä¹‹å¾Œçš„ç­æ¬¡</div>
              <div class="later-list">
                ${laterBuses.map(t => `<div class="later-item">${formatTime(t)}</div>`).join('')}
              </div>
            </div>
          `;
        }
      }
      
      // åŠ å…¥æ™‚åˆ»è¡¨é¢æ¿
      content += renderSchedulePanel(direction);
      
      app.innerHTML = content;
    }

    function setDirection(dir) {
      direction = dir;
      render();
    }
    
    function toggleSchedule() {
      scheduleOpen = !scheduleOpen;
      render();
    }
    
    function renderSchedulePanel(dir) {
      const weekdayTimes = schedule.weekday[dir].map(t => formatTime(t));
      const weekendTimes = schedule.weekend[dir].map(t => formatTime(t));
      
      return `
        <button class="schedule-toggle" onclick="toggleSchedule()">
          ${scheduleOpen ? 'â–² æ”¶èµ·æ™‚åˆ»è¡¨' : 'â–¼ æŸ¥çœ‹å®Œæ•´æ™‚åˆ»è¡¨'}
        </button>
        
        <div class="schedule-panel ${scheduleOpen ? 'open' : ''}">
          <div class="schedule-section">
            <div class="schedule-section-title">ğŸ“… å¹³æ—¥ï¼ˆé€±ä¸€è‡³é€±äº”ï¼‰</div>
            <div class="schedule-times">
              ${weekdayTimes.map(t => `<span class="schedule-time">${t}</span>`).join('')}
            </div>
          </div>
          
          <div class="schedule-section">
            <div class="schedule-section-title">ğŸ“… é€±æœ«åŠå‡æ—¥</div>
            <div class="schedule-times">
              ${weekendTimes.map(t => `<span class="schedule-time">${t}</span>`).join('')}
            </div>
          </div>
          
          <div class="schedule-note">
            âš ï¸ æ¯æ—¥ 15:05 - 15:59 ç„¡ç­æ¬¡
          </div>
        </div>
      `;
    }

    // è¼‰å…¥æ™‚åˆ»è¡¨å¾Œé–‹å§‹
    loadSchedule();
    
    // æ¯ç§’æ›´æ–°
    setInterval(render, 1000);
    
    // åˆ‡å› tab æ™‚ç«‹åˆ»æ›´æ–°
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) {
        render();
      }
    });

    // è¨»å†Š Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(registration => {
            console.log('ServiceWorker registration successful');
          })
          .catch(err => {
            console.log('ServiceWorker registration failed: ', err);
          });
      });
    }
  </script>
</body>
</html>
